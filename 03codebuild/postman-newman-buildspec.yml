version: 0.2

env:
  variables:
    S3_BUCKET: "kodnest-users"

phases:
  install:
    runtime-versions:
      nodejs: 10
    commands:
      - npm install -g newman
      - yum install -y jq

  pre_build:
    commands:
      - aws s3 cp s3://${S3_BUCKET}/postman-env-files/PetStoreAPIEnvironment.postman_environment.json ./02postman/
      - aws s3 cp s3://${S3_BUCKET}/postman-env-files/PetStoreAPI.postman_collection.json ./02postman/
      - cd ./02postman
      - chmod +x ./update-postman-env-file.sh
      - ./update-postman-env-file.sh

  build:
    commands:
      - echo Build started on `date` from dir `pwd`
      - newman run "PetStoreAPI.postman_collection.json" --environment "PetStoreAPIEnvironment.postman_environment.json" --reporters "cli,junit" --reporter-junit-export "newman-report.xml"

  post_build:
    commands:
      - echo Tests completed on `date`
      - aws s3 cp ./02postman/newman/ s3://${S3_BUCKET}/postman-reports/ --recursive --exclude "*" --include "*.xml"

reports:
  junitreports:
    files:
      - '**/*.xml'
    base-directory: '02postman/newman'
